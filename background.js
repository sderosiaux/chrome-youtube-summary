// background.js
console.log("YouTube Summary: Background script loaded");

chrome.runtime.onInstalled.addListener(() => {
  console.log("YouTube Summary: Extension installed");
});

// Handle messages from content script
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  console.log("YouTube Summary: Message received in background:", request);

  if (request.action === "generateSummary") {
    generateAISummary(request)
      .then((summary) => {
        sendResponse({ summary });
      })
      .catch((error) => {
        console.error("YouTube Summary: Error generating summary:", error);
        sendResponse({ error: error.message });
      });
    return true; // Keep message channel open for async response
  }

  if (request.action === "generateQA") {
    generateQAExtraction(request)
      .then((qa) => {
        sendResponse({ qa });
      })
      .catch((error) => {
        console.error("YouTube Summary: Error generating Q&A:", error);
        sendResponse({ error: error.message });
      });
    return true;
  }

  return true;
});

// Generate AI summary using OpenAI API
async function generateAISummary({ transcript, title, channel, url }) {
  try {
    // Get API key from storage
    const result = await chrome.storage.sync.get([
      "openaiApiKey",
      "customPrompt",
    ]);
    const apiKey = result.openaiApiKey;

    if (!apiKey) {
      throw new Error(
        "OpenAI API key not configured. Please set it in the extension options.",
      );
    }

    // Default prompt if none provided
    const customPrompt = `
RÃ©sumÃ© EXHAUSTIF en franÃ§ais â€¢ Termes techniques â†’ anglais â€¢ Longueur proportionnelle au contenu

STYLE: Incisif, direct â€¢ Symboles: â†’, â‰ , ~, +, *, etc.

TYPE AUTO-DÃ‰TECTÃ‰:
- TALK/CONFÃ‰RENCE â†’ thÃ¨se + arguments + implications
- REVIEW/ANALYSE â†’ mÃ©thodologie + Ã©valuation + recommandations

---

## TL;DR
â†’ Une phrase brutale capturant l'essence

## Contexte
* [TALK] ThÃ¨se dÃ©fendue + pourquoi maintenant | [REVIEW] Sujet + angle d'analyse
* ProblÃ©matique & positionnement dans le domaine

## Points ClÃ©s (8-12)
ClassÃ©s par importance dÃ©croissante. Pour chaque point:
* **Point** â†’ Affirmation factuelle extraite de la transcription
  - ğŸ’­ *Opinion*: Position/jugement de l'auteur (si applicable)
  - ğŸ“Š *Preuve*: DonnÃ©e/Ã©tude/stat citÃ©e (si applicable)
  - âš¡ *Impact*: ConsÃ©quence pratique

## DonnÃ©es & Stats
Extraire TOUS les chiffres mentionnÃ©s:
* % | Montants | Volumes | Dates | Comparaisons | MÃ©triques

## Citations ClÃ©s
* ğŸ“Œ Factuelles (vÃ©rifiables)
* ğŸ’¬ Opinionnelles (jugements personnels)
* âš ï¸ Ã€ vÃ©rifier (claims sans source)

## Actions
* ğŸ”¥ IMMÃ‰DIAT: Action â†’ rÃ©sultat rapide
* ğŸ“… COURT TERME: Action â†’ prÃ©requis â†’ ROI attendu
* ğŸ¯ LONG TERME: Vision â†’ Ã©tapes â†’ indicateurs

## Mindmap
\`\`\`
SUJET PRINCIPAL
â”œâ”€ Concept 1
â”‚  â”œâ”€ Sous-concept A
â”‚  â””â”€ Sous-concept B
â”œâ”€ Concept 2
â”‚  â””â”€ Application pratique
â””â”€ Concept 3
   â””â”€ Implication majeure
\`\`\`

## SynthÃ¨se
* Ã‰lÃ©ments majeurs + prochaines Ã©tapes logiques
* âš ï¸ Points faibles/manquant de support
* Confiance: ğŸŸ¢ Ã‰LEVÃ‰E | ğŸŸ¡ MOYENNE | ğŸ”´ FAIBLE
    `.trim();

    const prompt = `
${customPrompt}

Video Title: ${title}
Channel: ${channel || "Unknown"}

Transcript:
${transcript}
    `.trim();

    console.log("YouTube Summary: Making OpenAI API request");

    const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${apiKey}`,
      },
      body: JSON.stringify({
        model: "gpt-5.1",
        messages: [
          {
            role: "user",
            content: prompt,
          },
        ],
        max_completion_tokens: 8000,
        temperature: 0.7,
      }),
    });

    if (!response.ok) {
      const errorData = await response.json();
      console.error("YouTube Summary: OpenAI API error response:", JSON.stringify(errorData, null, 2));
      console.error("YouTube Summary: HTTP status:", response.status, response.statusText);
      throw new Error(
        `OpenAI API error: ${errorData.error?.message || response.statusText}`,
      );
    }

    const data = await response.json();
    const summary = data.choices[0]?.message?.content?.trim();

    if (!summary) {
      throw new Error("No summary generated by OpenAI API");
    }

    console.log("YouTube Summary: Summary generated successfully");
    return summary;
  } catch (error) {
    console.error("YouTube Summary: Error in generateAISummary:", error);
    console.error("YouTube Summary: Full error details:", error.message, error.stack);
    throw error;
  }
}

// Generate Q&A extraction using OpenAI API
async function generateQAExtraction({ transcript, title, channel, url }) {
  try {
    // Get API key from storage
    const result = await chrome.storage.sync.get(["openaiApiKey"]);
    const apiKey = result.openaiApiKey;

    if (!apiKey) {
      throw new Error(
        "OpenAI API key not configured. Please set it in the extension options.",
      );
    }

    const qaPrompt = `Tu es mon extracteur de Q&A pour les vidÃ©os et webinars avec des intervenants.
Ã€ partir de la transcription ci-dessous, trouve les questions posÃ©es par l'hÃ´te ou l'intervieweur et les rÃ©ponses donnÃ©es par le(s) invitÃ©(s).

IMPORTANT: RÃ©ponds TOUJOURS en franÃ§ais, peu importe la langue de la discussion.

Retourne le rÃ©sultat dans ce format exact:

Question: <paraphrase trÃ¨s courte de la question en franÃ§ais>
- <rÃ©ponse trÃ¨s rÃ©sumÃ©e, focus sur ce qu'ils expliquent ou affirment rÃ©ellement>

RÃ¨gles:
- Ignore les bavardages et l'intendance (bienvenue, sponsors, cafÃ©, bons de rÃ©duction, "tu m'entends ?", etc.).
- Fusionne les questions de suivi dans la question principale quand elles restent sur le mÃªme sujet.
- Saute les questions ou rÃ©ponses rÃ©pÃ©tÃ©es.
- Utilise un langage simple et direct, pas de hype, pas de blabla.
- S'il y a du contenu pÃ©dagogique qui n'est pas sous forme Q&A, ignore-le sauf s'il rÃ©pond clairement Ã  une question de l'hÃ´te.
- Si cette vidÃ©o ne semble pas Ãªtre au format interview, webinar, session Q&A ou panel, rÃ©ponds: "Ce contenu ne semble pas Ãªtre au format Q&A (interview, webinar, panel)."`;

    const prompt = `
${qaPrompt}

Video Title: ${title}
Channel: ${channel || "Unknown"}

Transcript:
${transcript}
    `.trim();

    console.log("YouTube Summary: Making OpenAI API request for Q&A");

    const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${apiKey}`,
      },
      body: JSON.stringify({
        model: "gpt-5.1",
        messages: [
          {
            role: "user",
            content: prompt,
          },
        ],
        max_completion_tokens: 4000,
        temperature: 0.5,
      }),
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(
        `OpenAI API error: ${errorData.error?.message || response.statusText}`,
      );
    }

    const data = await response.json();
    const qa = data.choices[0]?.message?.content?.trim();

    if (!qa) {
      throw new Error("No Q&A generated by OpenAI API");
    }

    console.log("YouTube Summary: Q&A generated successfully");
    return qa;
  } catch (error) {
    console.error("YouTube Summary: Error in generateQAExtraction:", error);
    throw error;
  }
}

// Handle extension icon click
chrome.action.onClicked.addListener((tab) => {
  if (tab.url.includes("youtube.com/watch")) {
    chrome.tabs.sendMessage(tab.id, { action: "triggerSummary" });
  } else {
    console.log("YouTube Summary: Not on a YouTube video page");
  }
});

// Handle keyboard shortcut
chrome.commands.onCommand.addListener((command) => {
  if (command === "trigger-summary") {
    chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
      const tab = tabs[0];
      if (tab && tab.url.includes("youtube.com/watch")) {
        chrome.tabs.sendMessage(tab.id, { action: "triggerSummary" });
      } else {
        console.log("YouTube Summary: Not on a YouTube video page");
      }
    });
  }
});
